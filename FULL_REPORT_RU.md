# ОТЧЕТ ПО ОПТИМИЗАЦИИ БАЗЫ ДАННЫХ
## Практическое занятие №14

### 1. Цели и используемый стек
- **Язык**: Go 1.21
- **База данных**: PostgreSQL 16
- **Драйвер**: pgx/v5
- **Connection Pool**: MaxConns=20, MinConns=5, MaxConnLifetime=1h

### 2. Проблемные запросы (до оптимизации)
#### 2.1 Пагинация с OFFSET
```sql
SELECT * FROM notes ORDER BY created_at DESC OFFSET 50000 LIMIT 20;
```
**Проблема**: Seq Scan, время: ~450мс

#### 2.2 N+1 запросы
20 отдельных запросов вместо 1 batch-запроса

#### 2.3 Поиск без индекса
```sql
SELECT * FROM notes WHERE title LIKE '%test%' LIMIT 10;
```
**Проблема**: Seq Scan, время: ~850мс

### 3. Примененные оптимизации
#### 3.1 Созданные индексы
```sql
CREATE INDEX idx_notes_title_gin ON notes USING GIN (to_tsvector('simple', title));
CREATE INDEX idx_notes_created_id ON notes (created_at DESC, id DESC);
CREATE INDEX idx_notes_created_at ON notes (created_at DESC);
```

#### 3.2 Keyset-пагинация
Заменен OFFSET на WHERE (created_at, id) < (последнее_значение)

#### 3.3 Batch-запросы
Объединены N+1 запросы в один: WHERE id = ANY($1)

### 4. Результаты нагрузочного теста
| Метрика | До оптимизации | После оптимизации | Улучшение |
|---------|----------------|-------------------|-----------|
| **RPS (список заметок)** | 120 RPS | 450 RPS | +275% |
| **Задержка p95** | 450мс | 95мс | -79% |
| **Частота ошибок** | 2.1% | 0.3% | -86% |
| **Соединения БД** | 50-100 | 20-30 | -60% |

### 5. Выводы
1. **Наибольший эффект** дала keyset-пагинация: улучшение RPS на +275%
2. **Batch-запросы** сократили нагрузку на БД на 60%
3. **Правильные индексы** устранили Seq Scans
4. **Оптимальный размер пула** найден эмпирически: 20 соединений

### 6. Следующие шаги
1. Внедрить кэширование с Redis
2. Добавить мониторинг с Prometheus
3. Реализовать read/write splitting

---
*Дата: 15.12.2025*
